const $ = (s) => document.querySelector(s);
const set = (sel, txt) => { const el = $(sel); if (el) el.textContent = txt; };

(async function init(){
  set('#year', new Date().getFullYear());

  // Load product config
  const res = await fetch('/data/product.json');
  const cfg = await res.json();

  set('#brand', cfg.brand); set('#brand2', cfg.brand); set('#brand3', cfg.brand); set('#brand4', cfg.brand);
  set('#productName', cfg.productName);
  set('#price', cfg.priceDisplay);
  set('#currency', cfg.currency === 'EUR' ? '€' : (cfg.currency || '€'));
  if (cfg.heroImage) $('#heroImage').src = cfg.heroImage;

  const ul = $('#highlights'); ul.innerHTML = '';
  (cfg.highlights || []).forEach(h => { const li = document.createElement('li'); li.textContent = `✔ ${h}`; ul.appendChild(li); });

  const faqList = $('#faqList'); faqList.innerHTML = '';
  (cfg.faq || []).forEach(item => {
    const d = document.createElement('details'); const s = document.createElement('summary'); s.textContent = item.q;
    const p = document.createElement('p'); p.textContent = item.a; d.appendChild(s); d.appendChild(p); faqList.appendChild(d);
  });

  // Buy button → create Stripe Checkout session (direct to function)
  const buyBtn = $('#buyButton');
  buyBtn?.addEventListener('click', async () => {
    buyBtn.disabled = true; buyBtn.textContent = 'Please wait…';
    try {
      const r = await fetch('/.netlify/functions/createCheckout', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ sku: cfg.sku, productName: cfg.productName })
      });
      if (!r.ok) throw new Error(await r.text());
      const { url } = await r.json();
      window.location.href = url;
    } catch (e) {
      alert('Checkout failed. Please try again.');
      console.error(e);
      buyBtn.disabled = false; buyBtn.textContent = 'Buy now';
    }
  });

  document.title = `${cfg.brand} – ${cfg.productName}`;
})();
